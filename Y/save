#!/bin/bash -eu

. "$(dirname "$(realpath "$0")")/COMMON"

termux_gen_world()
{
	[ "$in_termux" = 1 ] || return 0
	apt-mark showmanual > "$HOME/.termux/world"
}

flatpak_gen_world()
{
	require cmd:flatpak 2>/dev/null || return 0
	LANG=C flatpak list --app --columns=name | tail +2 > "$dir/FLATPAK_WORLD"
}

add_files()
{
	_y rm -rqf --ignore-unmatch --cached "$worktree"
	_y -C "$worktree" add --pathspec-from-file="$pathlist"
	is_empty "$excludelist" || \
	  _y -C "$worktree" rm -rqf --ignore-unmatch --cached \
	  --pathspec-from-file="$excludelist"
}

confirmation()
{
	_y --no-pager diff --cached --stat
	while true
	do echo "Continue?"
	echo "y:commit n:discard v:verbose"
	read -r input
	case "$input" in
	y|Y) return 0;;
	n|N) error "operation cancelled";;
	v|V)	_y --no-pager diff --cached
		while true
		do echo "Confirm?"
		echo "y:commit n:discard"
		read -r input
		case "$input" in
		y|Y) return 0;;
		n|N) error "operation cancelled";;
		esac
		done;;
	esac
	done
}

do_commit()
{
	_y commit -qm "$1"
}

show_result()
{
	_y --no-pager show --stat
}

ask_push()
{
	echo "Push now?"
	echo "y:push f:push(force) n:skip"
	read -r input
	case "$input" in
	y|Y) _y push; pushed=1;;
	f|F) _y push -f; pushed=1;;
	n|N) echo "Don't forget to push";;
	esac
}

useconfig "${1-}"; shift

termux_gen_world
flatpak_gen_world
add_files
confirmation

do_commit "${1-update}"

show_result
ask_push || error "Push failed, try to manually push"
